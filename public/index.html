<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Galactic Empires</title>
  <style>
    body { margin: 0; background: black; color: white; font-family: Arial, sans-serif; overflow: hidden; }
    #layout { display: flex; height: 100vh; width: 100vw; }
    #sidebar { width: 25vw; min-width: 360px; max-width: 560px; background: #0f0f0f; border-right: 1px solid #333; padding: 12px; box-sizing: border-box; overflow-y: auto; }
    #map { flex: 1; display: block; }

    .muted { color: #aaa; font-size: 12px; }
    .section { margin-top: 14px; padding-top: 12px; border-top: 1px solid #222; }

    button {
      width: 100%;
      margin-top: 8px;
      padding: 10px;
      background: #222;
      color: white;
      border: 1px solid #555;
      cursor: pointer;
      border-radius: 6px;
    }
    button:hover { background: #333; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Toggle red/armed state */
    button.armed {
      background: #6a1111;
      border-color: #cc4444;
    }
    button.armed:hover { background: #7a1515; }

    .row { display: flex; gap: 8px; align-items: center; margin-top: 6px; }
    .row label { flex: 1; font-size: 13px; }
    .row input, .row select {
      width: 220px;
      background: #111;
      color: white;
      border: 1px solid #444;
      padding: 6px;
      border-radius: 6px;
    }

    .smallbtn { padding: 7px 8px; margin-top: 0; border-radius: 6px; width: auto; white-space: nowrap; }

    .list { margin-top: 8px; border: 1px solid #222; border-radius: 8px; overflow: hidden; }
    .listItem {
      padding: 8px 10px;
      border-top: 1px solid #222;
      cursor: pointer;
      background: #0b0b0b;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      font-size: 12px;
    }
    .listItem:first-child { border-top: none; }
    .listItem:hover { background: #141414; }
    .listItem.selected { background: #1e1e1e; outline: 1px solid #444; }

    .pill { display: inline-block; padding: 2px 8px; border: 1px solid #444; border-radius: 999px; font-size: 12px; margin-right: 6px; color: #ddd; }

    #tooltip {
      position: absolute;
      background: rgba(0,0,0,0.92);
      border: 1px solid #666;
      padding: 8px 10px;
      font-size: 12px;
      pointer-events: none;
      display: none;
      z-index: 1000;
      max-width: 360px;
      border-radius: 8px;
    }

    #status { margin-top: 10px; font-size: 12px; color: #ccc; min-height: 16px; white-space: pre-wrap; }
    .twoCols { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }

    #report { margin-top: 8px; border: 1px solid #222; border-radius: 8px; overflow: hidden; background: #0b0b0b; }
    .reportLine { padding: 6px 10px; font-size: 12px; border-top: 1px solid #1a1a1a; white-space: pre-wrap; font-family: Consolas, monospace; color: #ddd; }
    .reportLine:first-child { border-top: none; }
    .combatHead { color: #fff; background: #121212; }
    .combatSub { color: #cfcfcf; padding-left: 22px; }
    .autoHead { color: #cfe9ff; }
    .researchHead { color: #ffd7a6; }
    .shipHead { color: #c9ffc9; }
    .miningHead { color: #cfcfff; }
    .gameHead { color: #ffb7b7; background:#1a0c0c; }

    /* Setup overlay */
    #setupOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.92);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
    }
    #setupCard {
      width: min(900px, 96vw);
      background: #0f0f0f;
      border: 1px solid #333;
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 0 30px rgba(0,0,0,0.6);
    }
    #setupCard h2 { margin: 0 0 10px 0; }
    #setupCard p { margin: 0 0 10px 0; color: #bbb; font-size: 13px; line-height: 1.4; }

    .setupGrid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; }
    .setupBox { border: 1px solid #242424; border-radius: 10px; padding: 10px; background: #0b0b0b; }
    .setupBox h3 { margin: 0 0 8px 0; font-size: 13px; color: #ddd; }

    .setupActions { display:flex; gap:10px; margin-top: 12px; }
    .setupActions button { width: 100%; }

    .linkBox {
      margin-top: 10px;
      padding: 10px;
      border: 1px solid #242424;
      border-radius: 10px;
      background: #070707;
      font-size: 12px;
      color: #ddd;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .joinRow { display:flex; gap: 10px; margin-top: 8px; }
    .joinRow input { width: 100%; }
  </style>
</head>
<body>

  <!-- Setup overlay -->
  <div id="setupOverlay">
    <div id="setupCard">
      <h2>Galactic Empires — Multiplayer Setup</h2>
      <p>
        Option 2 is enabled: each game has a <b>Game ID</b> and two <b>join codes</b> (one per faction).
        Share the Ithaxi link with Player A and the Hive link with Player B.
      </p>

      <div class="setupGrid">
        <div class="setupBox">
          <h3>Create new game</h3>

          <div class="row">
            <label>Open as</label>
            <select id="setupOpenAs">
              <option value="ithaxi">ithaxi</option>
              <option value="hive">hive</option>
            </select>
          </div>

          <div class="row"><label>Map width</label><input id="setupMapW" type="number" min="6" max="50" value="12"></div>
          <div class="row"><label>Map height</label><input id="setupMapH" type="number" min="6" max="50" value="12"></div>
          <div class="row"><label>Neutral systems</label><input id="setupNeutralCount" type="number" min="0" max="200" value="18"></div>

          <div class="row"><label>Home system resources</label><input id="setupHomeSysRes" type="number" min="0" max="500" value="10"></div>
          <div class="row"><label>Player treasury (unused)</label><input id="setupPlayerRes" type="number" min="0" max="500" value="50"></div>

          <div class="row"><label>JumpShips</label><input id="setupUJumpShip" type="number" min="0" max="50" value="1"></div>
          <div class="row"><label>Shipyards</label><input id="setupUShipyard" type="number" min="0" max="50" value="1"></div>
          <div class="row"><label>Mines</label><input id="setupUMine" type="number" min="0" max="200" value="1"></div>
          <div class="row"><label>Labs</label><input id="setupULab" type="number" min="0" max="50" value="0"></div>

          <div class="row"><label>Strikers</label><input id="setupUStriker" type="number" min="0" max="200" value="1"></div>
          <div class="row"><label>Escorts</label><input id="setupUEscort" type="number" min="0" max="200" value="1"></div>
          <div class="row"><label>Blockers</label><input id="setupUBlocker" type="number" min="0" max="200" value="0"></div>

          <div class="setupActions">
            <button id="setupCreateBtn">Create Game</button>
            <button id="setupCloseBtn" title="Close overlay if you're already joined">Close</button>
          </div>

          <div id="createdLinks" class="linkBox" style="display:none;"></div>
        </div>

        <div class="setupBox">
          <h3>Join existing game</h3>
          <div class="muted">
            If you were given a link, just open it in your browser — it will auto-join.
            Or paste the Game ID + join code below.
          </div>

          <div class="joinRow">
            <input id="joinGameId" placeholder="Game ID (e.g. k3z9n4p1q2)" />
          </div>
          <div class="joinRow">
            <input id="joinCode" placeholder="Join code (from your link)" />
          </div>
          <button id="joinBtn">Join Game</button>

          <div class="muted" style="margin-top:10px;">
            You will always see all star locations, but you won’t see owner/resources/value/events unless your units are there.
          </div>
        </div>
      </div>

      <div class="muted" style="margin-top: 10px;">
        Note: games are stored in server memory (so restarting the server clears them). We can add persistence later.
      </div>
    </div>
  </div>

  <div id="layout">
    <div id="sidebar">
      <h2 style="margin:0 0 6px 0;">Galactic Map</h2>
      <div id="turn" class="muted">Turn: ?</div>
      <div id="viewer" class="muted">You: ?</div>
      <div id="readyStatus" class="muted">Ready: ?</div>
      <div id="gameInfo" class="muted">Game: ?</div>

      <button id="readyTurnBtn">Ready for Turn Resolution</button>
      <button id="resignBtn">Resign (toggle)</button>
      <button id="confirmResignBtn" style="display:none;">Confirm Resign Now</button>

      <div class="section">
        <div><span class="pill">View</span> <span class="muted">Mouse wheel zoom + drag to pan</span></div>
        <div class="twoCols">
          <button id="zoomInBtn" class="smallbtn">Zoom In</button>
          <button id="zoomOutBtn" class="smallbtn">Zoom Out</button>
        </div>
        <button id="resetViewBtn">Reset View</button>
      </div>

      <div class="section">
        <h3 style="margin:0 0 8px 0; font-size: 14px;">Technology</h3>
        <div id="techLevels" class="muted">(loading)</div>
      </div>

      <div class="section">
        <h3 style="margin:0 0 8px 0; font-size: 14px;">Build</h3>
        <div id="buildHint" class="muted">Click a Shipyard to build units.</div>
        <div id="selectedShipyard" class="muted" style="margin-top:6px;"></div>

        <div id="buildPanel" style="display:none;">
          <div class="row"><label>Striker (2)</label><input id="bStriker" type="number" min="0" value="0"></div>
          <div class="row"><label>Escort (1)</label><input id="bEscort" type="number" min="0" value="0"></div>
          <div class="row"><label>Blocker (1)</label><input id="bBlocker" type="number" min="0" value="0"></div>
          <div class="row"><label>Mine (1)</label><input id="bMine" type="number" min="0" value="0"></div>
          <div class="row"><label>Lab (3)</label><input id="bLab" type="number" min="0" value="0"></div>

          <!-- NEW: allow building shipyards from shipyards (cost 10) -->
          <div class="row"><label>Shipyard (10)</label><input id="bShipyard" type="number" min="0" value="0"></div>

          <div class="row"><label>JumpShip (10)</label><input id="bJumpShip" type="number" min="0" value="0"></div>

          <button id="queueBuildBtn">Queue Build (selected Shipyard only)</button>
          <button id="clearBuildBtn">Clear</button>

          <div class="muted" style="margin-top:8px;">
            Rule: Shipyard spends up to <b>cap</b> resources per turn on <b>complete</b> units only (no partial).
          </div>
        </div>
      </div>

      <div class="section">
        <h3 style="margin:0 0 8px 0; font-size: 14px;">Research</h3>
        <div id="researchHint" class="muted">Click a Lab to research technology.</div>
        <div id="selectedLab" class="muted" style="margin-top:6px;"></div>

        <div id="researchPanel" style="display:none;">
          <div class="row">
            <label>Tech</label>
            <select id="researchTech"></select>
          </div>
          <div class="row">
            <label>Target level</label>
            <input id="researchTargetLevel" type="number" min="1" value="1">
          </div>
          <button id="queueResearchBtn">Queue Research (system+faction)</button>
          <div class="muted" style="margin-top:8px;">
            Rule: ALL labs of your faction in this system roll each turn; any “1” succeeds.
          </div>
        </div>
      </div>

      <div class="section">
        <h3 style="margin:0 0 8px 0; font-size: 14px;">Cargo</h3>
        <div id="cargoHint" class="muted">Click a JumpShip to manage cargo.</div>
        <div id="selectedJumpShip" class="muted" style="margin-top:6px;"></div>

        <div id="cargoPanel" style="display:none;">
          <div id="cargoSummary" class="muted"></div>

          <div style="margin-top:8px;">
            <div class="muted">Cargo list (click an entry to select)</div>
            <div id="cargoList" class="list"></div>
          </div>

          <div class="twoCols">
            <button id="unloadSelectedBtn" class="smallbtn" disabled>Unload selected</button>
            <button id="unloadAllBtn" class="smallbtn" disabled>Unload all</button>
          </div>

          <div style="margin-top:10px;">
            <div class="muted">Load unit(s): click a unit (or a stack) on the map (same system) then choose how many:</div>

            <div class="row">
              <label>How many</label>
              <input id="loadCount" type="number" min="1" value="1">
            </div>

            <button id="loadSelectedUnitBtn" disabled>Load N selected unit(s) into JumpShip</button>
            <div id="selectedUnitLine" class="muted" style="margin-top:6px;"></div>
          </div>

          <div style="margin-top:10px;">
            <div class="muted">Load resources from current system:</div>
            <div class="row">
              <label>Amount</label>
              <input id="resourceAmount" type="number" min="1" value="1">
            </div>
            <button id="loadResourcesBtn">Load resources</button>
          </div>

          <div style="margin-top:10px;">
            <div class="muted">Rare: Convert this JumpShip into a Shipyard (cost 16 system resources)</div>
            <button id="convertShipBtn">Convert JumpShip → Shipyard</button>
          </div>
        </div>
      </div>

      <div class="section">
        <h3 style="margin:0 0 8px 0; font-size: 14px;">Turn Report</h3>
        <div class="muted">Only events in systems where you have units are visible.</div>
        <div id="report"></div>
      </div>

      <div class="section">
        <button id="openSetupBtn">Setup / New Game</button>
        <div class="muted" style="margin-top:6px;">Clears your saved session and returns you to the setup overlay.</div>
      </div>

      <div id="status"></div>
    </div>

    <canvas id="map"></canvas>
  </div>

  <div id="tooltip"></div>
  <script src="/game.js" defer></script>
</body>
</html>
